resources:
  jobs:
    Extract_NHP_for_containers:
      name: Extract NHP for containers
      webhook_notifications:
        on_success:
          - id: 11be34cb-f1f0-42ca-99d8-e7b3e75e20ca
        on_failure:
          - id: 11be34cb-f1f0-42ca-99d8-e7b3e75e20ca
      tasks:
        - task_key: run_extract_apc_data
          for_each_task:
            inputs: "{{job.parameters.years}}"
            task:
              task_key: extract_ip_data
              python_wheel_task:
                package_name: nhp_data
                entry_point: model_data-ip
                parameters:
                  - "{{job.parameters.data_version}}"
                  - "{{input}}"
              job_cluster_key: run_nhp_extracts_cluster
              libraries:
                - whl: ../dist/*.whl
        - task_key: run_extract_opa_data
          depends_on:
            - task_key: run_extract_apc_data
          for_each_task:
            inputs: "{{job.parameters.years}}"
            task:
              task_key: extract_op_data
              python_wheel_task:
                package_name: nhp_data
                entry_point: model_data-op
                parameters:
                  - "{{job.parameters.data_version}}"
                  - "{{input}}"
              job_cluster_key: run_nhp_extracts_cluster
              libraries:
                - whl: ../dist/*.whl
        - task_key: run_extract_ecds_data
          depends_on:
            - task_key: run_extract_opa_data
          for_each_task:
            inputs: "{{job.parameters.years}}"
            task:
              task_key: extract_aae_data
              python_wheel_task:
                package_name: nhp_data
                entry_point: model_data-aae
                parameters:
                  - "{{job.parameters.data_version}}"
                  - "{{input}}"
              job_cluster_key: run_nhp_extracts_cluster
              libraries:
                - whl: ../dist/*.whl
        - task_key: run_extract_demographic_factors_data
          depends_on:
            - task_key: run_extract_ecds_data
          for_each_task:
            inputs: "{{job.parameters.years}}"
            task:
              task_key: extract_demographic_factors_data
              python_wheel_task:
                package_name: nhp_data
                entry_point: model_data-demographic_factors
                parameters:
                  - "{{job.parameters.data_version}}"
                  - "{{input}}"
                  - "{{job.parameters.projection_year}}"
              job_cluster_key: run_nhp_extracts_cluster
              libraries:
                - whl: ../dist/*.whl
        - task_key: run_extract_birth_factors_data
          depends_on:
            - task_key: run_extract_demographic_factors_data
          for_each_task:
            inputs: "{{job.parameters.years}}"
            task:
              task_key: extract_birth_factors_data
              python_wheel_task:
                package_name: nhp_data
                entry_point: model_data-birth_factors
                parameters:
                  - "{{job.parameters.data_version}}"
                  - "{{input}}"
                  - "{{job.parameters.projection_year}}"
              job_cluster_key: run_nhp_extracts_cluster
              libraries:
                - whl: ../dist/*.whl
        - task_key: run_extract_inequalities_data
          depends_on:
            - task_key: run_extract_birth_factors_data
          for_each_task:
            inputs: "{{job.parameters.years}}"
            task:
              task_key: extract_inequalities_data
              python_wheel_task:
                package_name: nhp_data
                entry_point: model_data-inequalities
                parameters:
                  - "{{job.parameters.data_version}}"
                  - "{{input}}"
              job_cluster_key: run_nhp_extracts_cluster
              libraries:
                - whl: ../dist/*.whl
        - task_key: generate_provider_gams
          depends_on:
            - task_key: run_extract_inequalities_data
          python_wheel_task:
            package_name: nhp_data
            entry_point: model_data-health_status_adjustment-generate_provider_gams
            parameters:
              - "{{job.parameters.data_version}}"
          job_cluster_key: run_nhp_extracts_cluster
          libraries:
            - pypi:
                package: pygam==0.9.1
            - whl: ../dist/*.whl
        - task_key: generate_icb_gams
          depends_on:
            - task_key: generate_provider_gams
          python_wheel_task:
            package_name: nhp_data
            entry_point: model_data-health_status_adjustment-generate_icb_gams
            parameters:
              - "{{job.parameters.data_version}}"
          job_cluster_key: run_nhp_extracts_cluster
          libraries:
            - pypi:
                package: pygam==0.9.1
            - whl: ../dist/*.whl
        - task_key: generate_national_gams
          depends_on:
            - task_key: generate_icb_gams
          python_wheel_task:
            package_name: nhp_data
            entry_point: model_data-health_status_adjustment-generate_national_gams
            parameters:
              - "{{job.parameters.data_version}}"
          job_cluster_key: run_nhp_extracts_cluster
          libraries:
            - pypi:
                package: pygam==0.9.1
            - whl: ../dist/*.whl
        - task_key: generate_synthetic_data
          depends_on:
            - task_key: generate_national_gams
          for_each_task:
            inputs: "{{job.parameters.years}}"
            task:
              task_key: run_generate_synthetic_data
              python_wheel_task:
                package_name: nhp_data
                entry_point: model_data-generate_synthetic_data
                parameters:
                  - "{{input}}"
                  - "20251001"
              job_cluster_key: run_nhp_extracts_cluster
              libraries:
                - whl: ../dist/*.whl
        - task_key: clean_up
          depends_on:
            - task_key: generate_synthetic_data
          python_wheel_task:
            package_name: nhp_data
            entry_point: model_data-clean_up
            parameters:
              - "{{job.parameters.data_version}}"
          job_cluster_key: run_nhp_extracts_cluster
          libraries:
            - whl: ../dist/*.whl
      job_clusters:
        - job_cluster_key: run_nhp_extracts_cluster
          new_cluster:
            cluster_name: ""
            spark_version: 16.4.x-scala2.13
            spark_conf:
              spark.master: local[*, 4]
              spark.databricks.cluster.profile: singleNode
            azure_attributes:
              first_on_demand: 1
              availability: ON_DEMAND_AZURE
              spot_bid_max_price: -1
            node_type_id: Standard_E8ads_v5
            driver_node_type_id: Standard_E8ads_v5
            custom_tags:
              ResourceClass: SingleNode
              project: nhp
            spark_env_vars:
              PYSPARK_PYTHON: /databricks/python3/bin/python3
            enable_elastic_disk: true
            data_security_mode: SINGLE_USER
            runtime_engine: STANDARD
            num_workers: 0
      tags:
        group: nhp_data_model
        env: ${bundle.target}
      queue:
        enabled: true
      parameters:
        - name: data_version
          default: dev
        - name: years
          default: "[202324]"
        - name: projection_year
          default: "2022"
